# Endpoints Cleanup Plan

**Objective**: Complete removal of all existing MCP and gRPC endpoints while maintaining core system functionality, ensuring all remaining tests pass and code compiles without TypeScript errors.

---

## üìã **Pre-Cleanup Assessment**

### Current System State
- **Total Tests**: ~277 tests currently passing
- **Dual Protocol**: MCP + gRPC endpoints
- **Generated Code**: Protocol buffer generated types
- **Expected Remaining**: ~200 tests (core functionality)
- **Expected Removed**: ~77 tests (endpoint-specific)

### Success Criteria
- ‚úÖ All remaining tests pass
- ‚úÖ TypeScript compiles without errors
- ‚úÖ Core functionality preserved (embeddings, search, caching, file watching)
- ‚úÖ Clean foundation for new endpoint implementation

---

## üéØ **Step-by-Step Cleanup Plan**

### **Step 1: Create Backup and Assessment** ‚úÖ
**Duration**: 15 minutes

```powershell
# Create backup branch
git checkout -b backup/pre-endpoints-cleanup
git add -A
git commit -m "Backup before endpoints cleanup"

# Create cleanup branch
git checkout -b feature/endpoints-cleanup
```

**Deliverables**:
- [x] Backup branch created
- [x] Clean working directory
- [x] Baseline test run completed

---

### **Step 2: Analyze Current Endpoint Dependencies** ‚è≥  
**Duration**: 30 minutes

**Tasks**:
- [ ] Document all files containing endpoint implementations
- [ ] Map test dependencies to endpoint code
- [ ] Identify shared utilities that can be preserved
- [ ] Create removal checklist

**Files to Analyze**:
- `proto/folder-mcp.proto`
- `src/generated/` directory
- `src/grpc/services/`
- `src/mcp/handlers/`
- `src/interfaces/mcp/handlers/`
- `tests/integration/protocols/`
- `tests/unit/grpc/`

**Deliverables**:
- [ ] Dependency map document
- [ ] File removal checklist
- [ ] Test impact assessment

---

### **Step 3: Remove Endpoint-Specific Tests** 
- [x] **Duration**: 45 minutes (COMPLETED)

**Rationale**: Remove tests first to prevent failures during implementation removal

**Tasks**:
- [ ] Remove protocol-specific test directories
- [ ] Remove API contract tests  
- [ ] Remove endpoint-specific E2E tests (preserve core E2E tests)

**Files to Remove**:
- [ ] `tests/integration/protocols/` (entire directory)
- [ ] `tests/unit/grpc/` (entire directory)  
- [ ] `tests/unit/interfaces/mcp.test.ts`
- [ ] Endpoint-specific files in `tests/e2e/`

**Validation**:
```powershell
npm test
```

**Deliverables**:
- [ ] Endpoint tests removed
- [ ] Core tests still passing
- [ ] Updated test count baseline

---

### **Step 4: Remove Protocol Buffer Schema and Generated Code**
- [x] **Duration**: 20 minutes (IN PROGRESS)

**Tasks**:
- [x] Remove protocol buffer schema (COMPLETED)
- [x] Remove all generated code (COMPLETED)
- [x] Update proto generation script (COMPLETED - removed)
- [ ] Fix TypeScript compilation errors (13 errors in 10 files identified)

**Files to Remove**:
- [ ] `proto/folder-mcp.proto`
- [ ] `src/generated/` (entire directory)

**Files to Update**:
- [ ] `scripts/generate-proto-types.js` (update or remove)
- [ ] `package.json` (remove proto generation script if present)

**Validation**:
```powershell
npm run build
```

**Deliverables**:
- [ ] Protocol schema removed
- [ ] Generated code cleaned
- [ ] Build process updated

---

### **Step 5: Remove gRPC Service Implementations**
- [x] **Duration**: 30 minutes (COMPLETED)

**Tasks**:
- [ ] Remove gRPC service implementations
- [ ] Clean gRPC server registration code

**Files to Remove**:
- [ ] `src/grpc/services/` (entire directory)

**Files to Update**:
- [ ] `src/grpc/server.ts` - Remove service registrations, keep basic server framework
- [ ] `src/transport/factory.ts` - Remove gRPC service routing
- [ ] `src/di/services.ts` - Remove gRPC service DI registrations

**Key Updates**:
```typescript
// src/grpc/server.ts - Keep basic structure:
export class GrpcServer {
  private server: grpc.Server;
  
  constructor() {
    this.server = new grpc.Server();
  }
  
  // Remove all .addService() calls
  // Keep basic start/stop methods
}
```

**Validation**:
```powershell
npm run build
npm test
```

**Deliverables**:
- [ ] gRPC services removed
- [ ] Basic gRPC framework preserved
- [ ] TypeScript compilation successful

---

### **Step 6: Remove MCP Handler Implementations**
- [x] **Duration**: 30 minutes (COMPLETED)

**Tasks**:
- [ ] Remove MCP handler implementations
- [ ] Remove MCP handler interfaces
- [ ] Clean MCP server tool registrations

**Files to Remove**:
- [ ] `src/mcp/handlers/` (entire directory)
- [ ] `src/interfaces/mcp/handlers/` (entire directory)

**Files to Update**:
- [ ] `src/interfaces/mcp/server.ts` - Remove tool registrations, keep basic MCP framework
- [ ] `src/mcp-server.ts` - Remove handler imports and registrations
- [ ] `src/di/services.ts` - Remove MCP handler DI registrations

**Key Updates**:
```typescript
// src/interfaces/mcp/server.ts - Keep basic structure:
export class McpServer {
  private server: Server;
  
  constructor() {
    this.server = new Server(/* config */);
  }
  
  // Remove all .setRequestHandler() calls
  // Keep basic start/stop methods
}
```

**Validation**:
```powershell
npm run build
npm test
```

**Deliverables**:
- [ ] MCP handlers removed
- [ ] Basic MCP framework preserved
- [ ] TypeScript compilation successful

---

### **Step 7: Clean Transport Layer Routing**
- [x] **Duration**: 45 minutes (COMPLETED)

**Tasks**:
- [ ] Update transport factory to remove endpoint-specific routing
- [ ] Clean typed transport interfaces
- [ ] Remove endpoint-specific transport utilities
- [ ] Preserve core transport framework

**Files to Update**:
- [ ] `src/transport/factory.ts` - Remove endpoint routing, keep transport creation
- [ ] `src/transport/typed-service.ts` - Remove endpoint type definitions
- [ ] `src/transport/typed-transport.ts` - Remove endpoint transport mapping
- [ ] `src/transport/types.ts` - Remove endpoint-specific types

**Key Updates**:
```typescript
// src/transport/factory.ts - Simplified structure:
export class TransportFactory {
  // Keep basic transport creation methods
  // Remove endpoint-specific routing logic
  
  createHttpTransport(): HttpTransport { /* ... */ }
  createLocalTransport(): LocalTransport { /* ... */ }
  // Remove service routing methods
}
```

**Validation**:
```powershell
npm run build
npm test
```

**Deliverables**:
- [ ] Transport routing cleaned
- [ ] Core transport framework preserved
- [ ] All imports resolved

---

### **Step 8: Update Configuration Schema**
- [x] **Duration**: 30 minutes (COMPLETED)

**Tasks**:
- [ ] Remove endpoint-specific configuration options
- [ ] Preserve core transport and server configurations
- [ ] Update configuration validation
- [ ] Update default configurations

**Files to Update**:
- [ ] `src/config/schema.ts` - Remove endpoint config schemas
- [ ] `src/config/enhanced-mcp.ts` - Remove endpoint configurations
- [ ] `src/config/grpc-config.ts` - Keep basic gRPC config, remove service configs
- [ ] `config.yaml` - Remove endpoint-specific configurations

**Key Updates**:
```typescript
// src/config/schema.ts - Remove endpoint schemas:
export const ConfigSchema = z.object({
  server: ServerConfigSchema,      // Keep
  transport: TransportConfigSchema, // Keep
  cache: CacheConfigSchema,        // Keep
  logging: LoggingConfigSchema,    // Keep
  // Remove: endpoints, services, tools, etc.
});
```

**Validation**:
```powershell
npm run build
npm test
npm run start -- --help  # Test CLI still works
```

**Deliverables**:
- [ ] Configuration cleaned
- [ ] Core configs preserved
- [ ] CLI functionality maintained

---

### **Step 9: Clean CLI Commands**
**Duration**: 20 minutes

**Tasks**:
- [ ] Remove endpoint testing commands
- [ ] Update serve commands to remove endpoint-specific functionality

**Files to Remove**:
- [ ] `src/interfaces/cli/commands/test-transport.ts`
- [ ] `src/interfaces/cli/commands/test-grpc.ts`
- [ ] Any other endpoint-testing CLI commands

**Files to Update**:
- [ ] `src/interfaces/cli/commands/serve.ts` - Remove endpoint initialization
- [ ] CLI command registration files - Remove endpoint command registrations

**Validation**:
```powershell
npm run build
node dist/index.js --help
```

**Deliverables**:
- [ ] CLI commands cleaned
- [ ] Core serve functionality preserved
- [ ] Help documentation updated

---

### **Step 10: Remove Unused Dependencies**
**Duration**: 15 minutes

**Tasks**:
- [ ] Identify dependencies only used for endpoints
- [ ] Remove unused packages
- [ ] Update package.json scripts
- [ ] Clean lock files

**Dependencies to Review**:
- [ ] `@grpc/proto-loader` (if not using gRPC)
- [ ] `protobufjs` (if not using protocol buffers)
- [ ] Endpoint-specific validation libraries
- [ ] Testing utilities for removed endpoints

**Files to Update**:
- [ ] `package.json` - Remove unused dependencies and scripts
- [ ] Update npm scripts that reference removed functionality

**Validation**:
```powershell
npm install
npm run build
npm test
```

**Deliverables**:
- [ ] Unused dependencies removed
- [ ] Package.json cleaned
- [ ] All scripts functional

---

### **Step 11: Fix Import Errors and Type Issues**
**Duration**: 60 minutes

**Tasks**:
- [ ] Fix all TypeScript compilation errors
- [ ] Update import statements
- [ ] Remove unused type definitions
- [ ] Update DI container registrations

**Common Issues to Fix**:
- [ ] Missing imports for removed modules
- [ ] Unused type definitions
- [ ] Dead code elimination
- [ ] DI container cleanup

**Files Likely to Need Updates**:
- [ ] `src/di/container.ts` - Remove endpoint service registrations
- [ ] `src/di/services.ts` - Clean service definitions
- [ ] `src/index.ts` - Remove endpoint imports
- [ ] `src/mcp-server.ts` - Clean main server file

**Validation Process**:
```powershell
# Fix compilation errors iteratively
npm run build

# Fix any remaining test issues
npm test

# Run linting
npm run lint
```

**Deliverables**:
- [ ] Zero TypeScript errors
- [ ] All imports resolved
- [ ] Clean compilation

---

### **Step 12: Final Validation and Documentation**
**Duration**: 30 minutes

**Tasks**:
- [ ] Run complete test suite
- [ ] Verify core functionality works
- [ ] Update documentation
- [ ] Create summary report

**Validation Checklist**:
- [ ] `npm run build` - No TypeScript errors
- [ ] `npm test` - All remaining tests pass
- [ ] `npm run lint` - No linting errors
- [ ] Core services start without errors
- [ ] File watching works
- [ ] Embedding system functional
- [ ] Search system functional
- [ ] Cache system functional

**Final Commands**:
```powershell
# Complete validation
npm run build
npm test
npm run lint

# Test core functionality
npm run start -- serve --help
```

**Deliverables**:
- [ ] All tests passing
- [ ] Clean compilation
- [ ] Updated documentation
- [ ] Cleanup summary report

---

## üìä **Expected Results**

### **Files Removed** (~25-30 files)
- Protocol buffer schema
- Generated code directory
- gRPC service implementations
- MCP handler implementations
- Endpoint-specific tests
- Transport testing commands

### **Files Updated** (~15-20 files)
- Core server files (cleaned of endpoint registrations)
- Transport layer (routing removed)
- Configuration schema (endpoint configs removed)
- DI container (service registrations cleaned)
- Main application files (imports updated)

### **Tests Remaining** (~200 tests)
- Domain logic tests
- Infrastructure tests
- Application service tests
- Core integration tests
- Performance tests
- Architectural tests

### **Preserved Functionality**
- ‚úÖ File watching and indexing
- ‚úÖ Embedding generation and storage
- ‚úÖ Vector search capabilities
- ‚úÖ Caching system
- ‚úÖ Configuration management
- ‚úÖ Logging and monitoring
- ‚úÖ Core transport framework
- ‚úÖ Basic MCP and gRPC server setup

---

## üö® **Risk Mitigation**

### **Backup Strategy**
- Full backup branch created before starting
- Incremental commits after each step
- Test validation after each major change

### **Rollback Plan**
```powershell
# If issues arise, rollback to backup
git checkout backup/pre-endpoints-cleanup
git checkout -b feature/endpoints-cleanup-retry
```

### **Testing Strategy**
- Run tests after each step
- Validate core functionality preservation
- Monitor for unexpected failures

---

## üìù **Post-Cleanup Checklist**

- [ ] All TypeScript compilation errors resolved
- [ ] All remaining tests passing
- [ ] Core functionality verified
- [ ] No unused dependencies
- [ ] Clean import structure
- [ ] Updated documentation
- [ ] Git history clean
- [ ] Ready for new endpoint implementation

---

**Total Estimated Time**: 5-6 hours

**Complexity**: Medium-High (due to extensive codebase interconnections)

**Prerequisites**: Understanding of current system architecture and test coverage
