# Task 6: Basic Daemon Architecture Implementation Plan

**Objective**: Create daemon that manages single multi-folder MCP server

## üö® **Safety Framework**

### **Backup Strategy**
```bash
# Create backup branch before starting
git checkout -b backup/pre-daemon-architecture
git add -A
git commit -m "Backup before daemon architecture implementation"

# Create implementation branch  
git checkout -b feature/daemon-architecture
```

### **Rollback Plan**
```bash
# If major issues arise, return to backup
git checkout backup/pre-daemon-architecture 
git checkout -b feature/daemon-architecture-retry
```

### **Validation Commands**
```bash
# Run after each major task completion
npm run build        # Must compile without errors
npm test             # All tests must pass
git status           # Verify clean working state
```

## üéØ **Implementation Tasks**

### **Task 6.1: Daemon Process Foundation**

**[BEFORE STARTING: Break down this task into smaller assignments focusing on HOW to implement, not just WHAT to do. Update this task description when implementation begins.]**

- [ ] Create background daemon process structure
- [ ] Implement process lifecycle management (start/stop/restart)
- [ ] Add state persistence in ~/.folder-mcp/daemon-state.json
- [ ] Handle SIGTERM for graceful shutdown

**Validation After Completion**:
```bash
npm run build && npm test
git add -A && git commit -m "Task 6.1: Daemon process foundation completed"
```

### **Task 6.2: Single MCP Server Management**

**[BEFORE STARTING: Break down this task into smaller assignments focusing on HOW to implement, not just WHAT to do. Update this task description when implementation begins.]**

- [ ] Create MCP server spawning mechanism for single server
- [ ] Implement process monitoring and health checks
- [ ] Add automatic restart on crash with backoff
- [ ] Track MCP server PID and status

**Validation After Completion**:
```bash
npm run build && npm test
git add -A && git commit -m "Task 6.2: MCP server management completed"
```

### **Task 6.3: Multi-Folder Configuration**

**[BEFORE STARTING: Break down this task into smaller assignments focusing on HOW to implement, not just WHAT to do. Update this task description when implementation begins.]**

- [ ] Design configuration structure for multiple folders
- [ ] Implement folder list management in daemon state
- [ ] Create folder add/remove logic
- [ ] Validate folder paths and permissions

**Validation After Completion**:
```bash
npm run build && npm test
git add -A && git commit -m "Task 6.3: Multi-folder configuration completed"
```

### **Task 6.4: IPC Communication Setup**

**[BEFORE STARTING: Break down this task into smaller assignments focusing on HOW to implement, not just WHAT to do. Update this task description when implementation begins.]**

- [ ] Set up IPC mechanism for CLI/TUI to daemon communication
- [ ] Create command protocol for daemon operations
- [ ] Implement response handling and error reporting
- [ ] Add connection retry logic for robustness

**Validation After Completion**:
```bash
npm run build && npm test
git add -A && git commit -m "Task 6.4: IPC communication completed"
```

### **Task 6.5: Integration Testing**

**[BEFORE STARTING: Break down this task into smaller assignments focusing on HOW to implement, not just WHAT to do. Update this task description when implementation begins.]**

- [ ] Create automated tests for daemon lifecycle
- [ ] Test MCP server spawning and monitoring
- [ ] Verify state persistence across restarts
- [ ] Test graceful shutdown and recovery scenarios

**Validation After Completion**:
```bash
npm run build && npm test
git add -A && git commit -m "Task 6.5: Integration testing completed"
```

## üìä **Progress Tracking**

### **Current Status**
- [ ] Safety framework set up (backup branch created)
- [ ] Task 6.1: Daemon Process Foundation - Not Started
- [ ] Task 6.2: Single MCP Server Management - Not Started  
- [ ] Task 6.3: Multi-Folder Configuration - Not Started
- [ ] Task 6.4: IPC Communication Setup - Not Started
- [ ] Task 6.5: Integration Testing - Not Started

### **Completion Log**
| Task | Status | Completion Date | Commit Hash |
|------|--------|----------------|-------------|
| Safety Setup | ‚è≥ Pending | - | - |
| Task 6.1 | ‚è≥ Pending | - | - |
| Task 6.2 | ‚è≥ Pending | - | - |
| Task 6.3 | ‚è≥ Pending | - | - |
| Task 6.4 | ‚è≥ Pending | - | - |
| Task 6.5 | ‚è≥ Pending | - | - |

### **Quick Health Check**
```bash
# Run this anytime to verify system health
npm run build && npm test && git status
```

## üèóÔ∏è **Architecture Overview**

### **Daemon Process Structure**
```
daemon/
‚îú‚îÄ‚îÄ daemon.ts          # Main daemon process
‚îú‚îÄ‚îÄ server-manager.ts  # MCP server lifecycle management
‚îú‚îÄ‚îÄ state-manager.ts   # Persistent state handling
‚îú‚îÄ‚îÄ ipc-server.ts      # IPC communication handler
‚îî‚îÄ‚îÄ types.ts           # Shared type definitions
```

### **State File Structure**
```typescript
interface DaemonState {
  version: string;
  pid: number;
  startTime: Date;
  folders: Array<{
    path: string;
    addedAt: Date;
    status: 'active' | 'error' | 'indexing';
    lastIndexed?: Date;
  }>;
  mcpServer: {
    pid?: number;
    port: number;
    status: 'running' | 'stopped' | 'error';
    lastError?: string;
  };
}
```

### **IPC Protocol**
```typescript
interface DaemonCommand {
  type: 'add-folder' | 'remove-folder' | 'list-folders' | 'status' | 'stop' | 'restart';
  payload?: any;
}

interface DaemonResponse {
  success: boolean;
  data?: any;
  error?: string;
}
```

## üîç **Key Considerations**

### **Cross-Platform Support**
- Use Node.js `child_process` for process management
- Handle Windows service vs Unix daemon differences
- Ensure file paths work across platforms

### **Error Recovery**
- Implement exponential backoff for restart attempts
- Log all errors to ~/.folder-mcp/daemon.log
- Provide clear error messages to CLI/TUI

### **Performance**
- Minimize daemon memory footprint
- Efficient IPC message passing
- Lazy loading of MCP server resources

### **Security**
- Validate all folder paths to prevent directory traversal
- Secure IPC communication (local only)
- Proper file permissions on state files

## üìù **Implementation Notes**

1. **Start Simple**: Begin with basic process management, add features incrementally
2. **Test Early**: Each component should have unit tests before integration
3. **Document IPC**: Clear documentation of all daemon commands for CLI/TUI development
4. **Error Handling**: Every operation should have proper error handling and recovery
5. **Logging**: Implement structured logging from the start for debugging

## ‚úÖ **Definition of Done**

- [ ] Daemon starts and runs in background across platforms
- [ ] Single MCP server spawns with multiple folder support
- [ ] State persists across daemon restarts
- [ ] Graceful shutdown works reliably
- [ ] Auto-restart with backoff implemented
- [ ] IPC communication established and tested
- [ ] All automated tests passing
- [ ] Manual testing confirms stability
- [ ] Documentation updated with daemon usage